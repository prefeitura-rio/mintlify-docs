---
title: "Colabora√ß√£o com Reposit√≥rio de Queries"
description: "Guia completo para colaborar com o reposit√≥rio de queries da Prefeitura do Rio de Janeiro usando dbt e BigQuery"
---

# Colabora√ß√£o com Reposit√≥rio de Queries

Este guia explica como colaborar com o reposit√≥rio [queries-rj-iplanrio](https://github.com/prefeitura-rio/queries-rj-iplanrio) da Prefeitura do Rio de Janeiro, seguindo as melhores pr√°ticas de dbt e garantindo que seus modelos sejam materializados corretamente.

## ‚úÖ Pr√©-requisitos

- [Ambiente dbt configurado](https://iplan-rio.mintlify.app/data-lake/dbt/instalacao-dbt)
- Acesso ao projeto BigQuery `rj-iplanrio-dev`
- Permiss√µes de colaborador no reposit√≥rio GitHub
- Conhecimento b√°sico de Git e GitHub

## üîß Configura√ß√£o Inicial

### 1. Clonar o Reposit√≥rio

```bash
git clone https://github.com/prefeitura-rio/queries-rj-iplanrio.git
cd queries-rj-iplanrio
```

### 2. Configurar Ambiente de Desenvolvimento

Se tiver um ambiente virtual, ative-o:

```bash
# Ativar ambiente virtual
source dbt-env/bin/activate  # Linux/macOS
# ou
dbt-env\Scripts\activate     # Windows
```

Teste a conex√£o com o BigQuery:

```bash
# Verificar configura√ß√£o
dbt debug
```

<Warning>
  **IMPORTANTE**: Seus modelos ser√£o materializados no projeto BigQuery `rj-iplanrio-dev`. 
  Nunca use o ambiente de produ√ß√£o para desenvolvimento.
</Warning>

## üöÄ Boas Pr√°ticas de Desenvolvimento

### 1. Estrutura de Branch

```bash
# Criar branch para sua feature
git checkout -b feat/nome-da-feature

# Exemplo para modelo de sa√∫de
git checkout -b feat/modelo-dados-saude-sms
```

### 2. Nomenclatura de Modelos

Siga o padr√£o estabelecido:

```sql
-- ‚úÖ Correto: Nome descritivo e em snake_case
{{ config(materialized='table') }}
SELECT * FROM {{ ref('stg_sms_pacientes') }}

-- ‚ùå Evite: Nomes gen√©ricos
{{ config(materialized='table') }}
SELECT * FROM {{ ref('stg_data') }}
```

### 3. Uso Correto de `source` e `ref`

```sql
-- ‚úÖ Use source para dados externos
SELECT * FROM {{ source('sms', 'pacientes') }}

-- ‚úÖ Use ref para modelos dbt internos
SELECT * FROM {{ ref('stg_sms_pacientes') }}

-- ‚ùå Evite: Refer√™ncias diretas a tabelas
SELECT * FROM `rj-iplanrio-dev.sms.pacientes`
```

## üß™ Desenvolvimento e Testes

### 1. Executar Modelos Espec√≠ficos

Use `--select` para testar apenas seus modelos:

```bash
# Testar modelo espec√≠fico
dbt run --select nome_do_modelo

# Testar modelo e suas depend√™ncias
dbt build --select +nome_do_modelo

# Testar o modelo e todos os modelos dependem dele
dbt run --select nome_do_modelo+

# Testar todos os modelos de uma pasta
dbt run --select models/sms/*

# Testar todos os modelos com tag daily
dbt build --select tag:daily
```

<Note>
√â recomend√°vel que voc√™ fa√ßa seus testes com o comando `dbt build`, pois al√©m de rodar os modelos, ele tamb√©m executa seus testes.
</Note>



## üìù Workflow de Desenvolvimento

### 1. Desenvolvimento Local

1. **Crie os arquivos de metadados do seu projeto**
   - Para cada novo projeto, crie dois arquivos em `models/raw/secretaria/seu_projeto/`:
     - `_raw_seu_projeto__sources.yml`
     - `_raw_seu_projeto__schema.yml`
   - Esses arquivos s√£o importantes para registrar as fontes de dados e a documenta√ß√£o dos modelos.

   **Exemplo de `_raw_seu_projeto__sources.yml`:**
   ```yaml
   version: 2

   sources:
     - name: seu_projeto                # Nome da fonte de dados (ex: sms, saude, educacao)
       database: projeto_de_origem      # Projeto/dataset de origem no BigQuery
       schema: nome_do_schema           # Schema (conjunto de tabelas) de origem
       freshness:
         error_after: {count: 24, period: hour}  # Considera erro se os dados tiverem mais de 24h
       loaded_at_field: _airbyte_extracted_at    # Campo que indica quando o dado foi extra√≠do
       tables:
         - name: nome_da_tabela         # Nome da tabela de origem
   ```

   **Exemplo de `_raw_seu_projeto__schema.yml`:**
   ```yaml
   version: 2

   models:
     - name: seu_modelo # Nome do modelo
       description: "Descri√ß√£o do modelo" # Descri√ß√£o do modelo
       columns:
         - name: id # Nome da coluna
           description: "Identificador √∫nico" # Descri√ß√£o da coluna
         - name: nome # Nome da coluna
           description: "Nome do paciente" # Descri√ß√£o da coluna
   ```

2. **Configure sua pasta no `dbt_project.yml`**
   
   Ap√≥s criar os arquivos de metadados, voc√™ precisa adicionar a configura√ß√£o da sua pasta no arquivo `dbt_project.yml` do projeto. Isso permite que o DBT reconhe√ßa e processe seus modelos corretamente.

   **Exemplo de configura√ß√£o no `dbt_project.yml`:**
   ```yaml
   queries:
     mart:
       gerenciamento:
         custos:
           +tags: ["daily", "custos"]
       sme:
         frequencia:
           +materialized: table
           +schema: frequencia
           +tags: ["daily", "sme"]
           +project: rj-sme
   ```

   **Explica√ß√£o das configura√ß√µes:**
   - `+tags`: Define tags para organiza√ß√£o e filtros (ex: daily, custos, sme).
     - As tags `daily` e `weekly` s√£o especialmente importantes: elas determinam a frequ√™ncia com que o Prefect ir√° executar seu modelo automaticamente. Se voc√™ marcar um modelo com a tag `daily`, o Prefect ir√° agend√°-lo para rodar todos os dias; se marcar com `weekly`, ele ser√° executado semanalmente.
   - `+materialized`: Define como o modelo ser√° materializado (table, view, incremental).
   - `+schema`: Define o dataset espec√≠fico onde o modelo ser√° criado.
   - `+project`: Define o projeto espec√≠fico do BigQuery em que o modelo ser√° criado.

3. **Escreva ou edite seu modelo**
   - Crie um novo arquivo `.sql` em `models/` ou edite um modelo existente.
   - Exemplo: `models/raw/secretaria/seu_projeto/seu_modelo.sql`
   - Lembre-se de usar `ref()` para depend√™ncias internas e `source()` para dados externos.

4. **Ative o ambiente virtual**
   ```bash
   source dbt-env/bin/activate
   ```

5. **Execute o modelo para testar**
   ```bash
   dbt build --select seu_modelo --target dev
   ```

6. **Verifique o resultado no BigQuery**
   - Acesse o console do [BigQuery](https://console.cloud.google.com/bigquery).
   - Navegue at√© o projeto `rj-iplanrio-dev` e verifique se o dataset correspondente foi criado.
   - Confirme se a tabela ou view do seu modelo foi criada e os dados est√£o corretos.

### 2. Commit e Push

```bash
# 1. Adicionar arquivos
git add models/seu_modelo.sql
git add models/schema.yml

# 2. Commit com mensagem descritiva
git commit -m "feat: adiciona modelo de dados de sa√∫de SMS

- Cria modelo stg_sms_pacientes
- Adiciona testes de qualidade
- Documenta fonte de dados"

# 3. Push para branch
git push origin feature/nome-da-feature
```

### 3. Pull Request

1. **Criar PR** no GitHub
2. **Descri√ß√£o**: Explicar mudan√ßas e impacto
3. **Review**: Solicitar revis√£o da equipe IplanRio
4. **Testes**: Garantir que todos os testes passem
5. **Merge**: Ap√≥s aprova√ß√£o, merge para `main`

#### Workflow de CI/CD Autom√°tico

Quando voc√™ cria um Pull Request, o sistema de CI/CD √© executado automaticamente para validar e testar seus modelos:

**üîç CI (Continuous Integration) - Executado em cada PR:**

- **Valida√ß√£o**: Executa `dbt debug` para verificar configura√ß√µes
- **Depend√™ncias**: Instala depend√™ncias com `dbt deps`
- **Build Incremental**: Executa apenas os modelos modificados usando `dbt build -s 'state:modified+'`
- **Ambiente Isolado**: Cria um dataset √∫nico no BigQuery `rj-iplanrio-dev` para cada execu√ß√£o do workflow
- **Testes Autom√°ticos**: Executa todos os testes definidos nos seus modelos

<Note>
  O workflow de CI cria um ambiente isolado para cada PR, garantindo que seus testes n√£o interfiram com outros desenvolvedores e que os modelos sejam validados em um ambiente limpo.
</Note>

**‚úÖ CD (Continuous Deployment) - Executado ap√≥s merge:**

- **Deploy Completo**: Executa todos os modelos com `dbt build`
- **Ambiente de Produ√ß√£o**: Utiliza o target `pr_prod` (Produ√ß√£o)
- **Manifest Atualizado**: Atualiza o `manifest.json` no Google Cloud Storage para futuras execu√ß√µes incrementais

<Warning>
  **IMPORTANTE**: O workflow de CI testa seus modelos em um dataset tempor√°rio no `rj-iplanrio-dev`. 
  Apenas ap√≥s o merge na branch master √© que os modelos s√£o executados em produ√ß√£o.
</Warning>

**üìä Monitoramento do CI/CD:**

- Acompanhe o progresso dos testes na aba "Actions" do seu PR
- Verifique os logs para identificar poss√≠veis erros
- Aguarde a aprova√ß√£o autom√°tica antes de solicitar review da equipe
- Se houver falhas, corrija os problemas e fa√ßa novo commit - o CI ser√° executado novamente


## üìö Recursos Adicionais

- [Instala√ß√£o do DBT](https://iplan-rio.mintlify.app/data-lake/dbt/instalacao-dbt)
- [Estrutura de Pastas](https://iplan-rio.mintlify.app/data-lake/dbt/estrutura-pastas)
- [Padr√µes YAML](https://iplan-rio.mintlify.app/data-lake/dbt/padroes-yaml)
- [Padr√µes Testes](https://iplan-rio.mintlify.app/data-lake/dbt/testes)
- [Reposit√≥rio GitHub](https://github.com/prefeitura-rio/queries-rj-iplanrio)

---

